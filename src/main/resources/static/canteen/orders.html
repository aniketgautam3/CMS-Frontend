<ul class="nav nav-pills justify-content-center nav-fill" role="tablist">
    <li class="nav-item" >
      <a class="nav-link active" id="todayOrderTab" href="#">Today's Orders</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="pastFutureOrdersTab" href="#">Past / Future Orders</a>
    </li>
</ul>
<div class="d-flex justify-content-end mt-2 me-4">
    <input type="date" id="date-picker" class="col-3 d-none" />
</div>
<div id="orders-list" class="container-fluid mt-3"></div>

<script>
	document.title = "Orders Management";

    // Default values
    let selectedDate = new Date(); // Today's date
    const today = new Date();
    document.getElementById('date-picker').value = (new Date(today - (24*60*60*1000))).toISOString().substr(0, 10); // set the default date of date picker to yesterday

    let orders = [];
    
    const displayOrdersList = () => {
        const ordersListElem = document.getElementById('orders-list');
        const filteredOrders = orders.filter(order => {
            const orderDate = new Date(order.orderDelivered);
            return orderDate.getDate() === selectedDate.getDate() &&
                orderDate.getMonth() === selectedDate.getMonth() &&
                orderDate.getFullYear() === selectedDate.getFullYear();
        });
        // List the orders
        ordersListElem.innerHTML = '';
        if(filteredOrders.length == 0) ordersListElem.innerHTML = 'No orders on this day.';
        filteredOrders.forEach((order) => {
            const orderElement = document.createElement("div");
            const orderDate = new Date(order.orderDelivered);
            orderElement.innerHTML = `
                <div class="card mt-2">
                <div class="card-header">
                    <span class="card-subtitle text-muted float-start">Status: <span class="${order.status != 'Delivered' ? 'text-danger' : 'text-success'}">${order.status}</span></span>
                    <span class="card-subtitle text-muted float-end">Order ID: ${order.id} at ${new Date(order.orderDelivered).toDateString()}</span>
                </div>
                <div class="card-body">
                    <b>Order Type:</b> ${order.orderType} <br/>
                    <b>Items:</b> <br/> 
                    ${order.cartItems.length === 0 ? "None" : order.cartItems.join(", ")} <br/>
                    <b>Feedback:</b> ${order.feedBack ?? "N/A"}
                </div>
                ${
                    // Display Mark as delivered button only if the order is pending and is for today
                    order.status === 'Pending' && orderDate.getDate() === today.getDate() && orderDate.getMonth() === today.getMonth() && orderDate.getFullYear() === today.getFullYear() ?
                    `
                    <div class="card-footer">
                        <button class="btn btn-success float-end">Mark as Delivered</button>
                    </div>
                    ` : ''
                }
                </div>
            `;
            ordersListElem.appendChild(orderElement);
        });
    }

    // Event Handlers
    document.getElementById('date-picker').addEventListener('change', (e) => {
        if (!document.getElementById('pastFutureOrdersTab').classList.contains('active'))
            return;
        selectedDate = new Date(e.target.value);
        displayOrdersList();
    });
    document.getElementById('todayOrderTab').addEventListener('click', (e) => {
        selectedDate = today;
        document.getElementById('todayOrderTab').classList.add('active');
        document.getElementById('pastFutureOrdersTab').classList.remove('active');
        document.getElementById('date-picker').classList.add('d-none');
        displayOrdersList();
    });
    document.getElementById('pastFutureOrdersTab').addEventListener('click', (e) => {
        selectedDate = new Date(document.getElementById('date-picker').value);
        document.getElementById('todayOrderTab').classList.remove('active');
        document.getElementById('pastFutureOrdersTab').classList.add('active');
        document.getElementById('date-picker').classList.remove('d-none');
        displayOrdersList();
    });
    fetch(`http://localhost:8080/order/getorders`).then(async res => {
        const responseJSON = await res.json();
        orders = responseJSON;
        console.log(orders);
        displayOrdersList();
    });
</script>