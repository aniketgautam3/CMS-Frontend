<ul class="nav nav-pills justify-content-center nav-fill" role="tablist">
    <li class="nav-item">
        <a class="nav-link active" id="todayOrderTab" href="#">Today's Orders</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="pastFutureOrdersTab" href="#">Past / Future Orders</a>
    </li>
</ul>
<div class="d-flex justify-content-end mt-2 me-4">
    <input type="date" id="date-picker" class="col-3 d-none" />
</div>
<div id="orders-list" class="container-fluid mt-3">
    Loading...
</div>

<script>
    document.title = "Orders Management";

    // -- Default values --
    let selectedDate = new Date(); // Today's date
    const today = new Date();
    document.getElementById('date-picker').value = (new Date(today - (24 * 60 * 60 * 1000))).toISOString().substr(0, 10); // set the default date of date picker to yesterday


    // -- Main Functions -- 
    let orders = [];
    const displayOrdersList = async () => {
        orders = await fetch(`http://localhost:8080/order/getorders`);
        orders = await orders.json();
        console.log(JSON.stringify(orders));

        const ordersListElem = document.getElementById('orders-list');
        const filteredOrders = orders.filter(order => {
            const orderDate = new Date(new Date(order.orderPlaced) + (24 * 60 * 60 * 1000));
            return orderDate.getDate() === selectedDate.getDate() &&
                orderDate.getMonth() === selectedDate.getMonth() &&
                orderDate.getFullYear() === selectedDate.getFullYear();
        });
        // Sort orders by status (Pending first, Delivered Next, Canceled third, any other state last), id
        filteredOrders.sort((a, b) => { 
            const statusOrder = { "Pending": 1, "Delivered": 2, "Canceled": 3 };
            console.log((statusOrder[a.status.trim()] || 4), a.status.trim(), statusOrder);
            if (statusOrder[a.status.trim()] != statusOrder[b.status.trim()]) {
                return (statusOrder[a.status.trim()] || 4) - (statusOrder[b.status.trim()] || 4);
            } 
            return a.id - b.id; 
        });

        // List the orders
        ordersListElem.innerHTML = '';
        if (filteredOrders.length == 0) ordersListElem.innerHTML = 'No orders on this day.';
        filteredOrders.forEach((order) => {
            const orderElement = document.createElement("div");
            const orderDate = new Date(new Date(order.orderPlaced) + (24 * 60 * 60 * 1000));
            orderElement.innerHTML = `
                <div class="card mt-2">
                <div class="card-header">
                    <span class="card-subtitle text-muted float-start">Status: <span class="${order.status != 'Delivered' ? 'text-danger' : 'text-success'}">${order.status}</span></span>
                    <span class="card-subtitle text-muted float-end">Order ID: ${order.id} at ${new Date(order.orderPlaced).toDateString()}</span>
                </div>
                <div class="card-body">
                    <b>Order Type:</b> ${order.orderType} <br/>
                    <b>Items:</b> <br/> 
                    ${order.cartItems.length === 0 ? "None" : order.cartItems.join(", ")} <br/>
                    <b>Feedback:</b> ${order.feedBack ?? "N/A"}
                </div>
                ${
                // Display Mark as delivered button only if the order is pending and is for today
                order.status === 'Pending' && orderDate.getDate() === today.getDate() && orderDate.getMonth() === today.getMonth() && orderDate.getFullYear() === today.getFullYear() ?
                    `
                    <div class="card-footer">
                        <button class="btn btn-success float-end" onclick="markAsDelivered('${order.id}')">Mark as Delivered</button>
                    </div>
                    ` : ''
                }
                </div>
            `;
            ordersListElem.appendChild(orderElement);
        });
    }

    // Event Handlers
    document.getElementById('date-picker').addEventListener('change', (e) => {
        if (!document.getElementById('pastFutureOrdersTab').classList.contains('active'))
            return;
        selectedDate = new Date(e.target.value);
        displayOrdersList();
    });
    document.getElementById('todayOrderTab').addEventListener('click', (e) => {
        selectedDate = today;
        document.getElementById('todayOrderTab').classList.add('active');
        document.getElementById('pastFutureOrdersTab').classList.remove('active');
        document.getElementById('date-picker').classList.add('d-none');
        displayOrdersList();
    });
    document.getElementById('pastFutureOrdersTab').addEventListener('click', (e) => {
        selectedDate = new Date(document.getElementById('date-picker').value);
        document.getElementById('todayOrderTab').classList.remove('active');
        document.getElementById('pastFutureOrdersTab').classList.add('active');
        document.getElementById('date-picker').classList.remove('d-none');
        displayOrdersList();
    });

    displayOrdersList();

    const markAsDelivered = async (orderId) => {
        const confirmRes = await askConfirm(`Are you sure you want to mark order number ${orderId} as delivered?`);
        if(!confirmRes) return;

        const response = await fetch(`http://localhost:8080/order/updatestatus/${orderId}/1`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        if (response.status === 200) {
            displayOrdersList();
            showToast("Successfully marked as delivered.", 3000, 'success');
        } else {
            showToast("Error adding items to menu", 3000, 'danger');
        }
    }

    // -- Util Functions --
    const showToast = async (msg, timeout, toastType = 'primary') => {
        const toast = document.createElement('div'); 
        toast.classList.add('toast', 'position-fixed', 'bottom-0', 'end-0', 'm-3', `bg-${toastType}`, `text-white`);
        toast.classList.add('toast', 'fade', 'position-fixed', 'bottom-0', 'end-0', 'm-3');
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        toast.innerHTML = `
        <div class="toast-body d-flex">
            <div>${msg}</div>
            <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close"></button>

        </div>
        `;
        document.body.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast, { autohide: true, delay: timeout });
        bsToast.show();
    }
    const askConfirm = async (message) => {
        return new Promise((resolve) => {
            const modal = document.createElement('div');
            modal.classList.add('modal', 'fade');
            modal.setAttribute('tabindex', '-1');
            modal.setAttribute('data-bs-backdrop', 'static');
            modal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h6 class="modal-title">${message}</h6>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="confirmButton">Confirm</button>
                        </div>
                    </div>
                </div>
                `;

            const confirmButton = modal.querySelector('#confirmButton');
            confirmButton.addEventListener('click', () => {
                modal.remove();
                resolve(true);
            });

            const backdrop = document.createElement('div');
            backdrop.classList.add('modal-backdrop', 'fade', 'show');

            document.body.appendChild(modal);
            document.body.appendChild(backdrop);

            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();

            modal.addEventListener('hidden.bs.modal', () => {
                 backdrop.remove();
                 modal.remove();
                 resolve(false);
            });
        });
    }
</script>