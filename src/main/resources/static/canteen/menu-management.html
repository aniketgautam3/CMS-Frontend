<div class="d-flex justify-content-end mt-2 me-4">
  <input type="date" id="date-picker" class="col-3" />
</div>
<ul class="nav nav-pills justify-content-center nav-fill mt-4" role="tablist">
  <li class="nav-item"> <a class="nav-link active" id="breakfastTab" href="#">Breakfast Menu</a> </li>
  <li class="nav-item"> <a class="nav-link" id="lunchTab" href="#">Lunch Menu</a> </li>
</ul>
<div id="menu-list" class="tab-pane fade show active">
</div>


<div class="modal fade item-manager-model" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLongTitle">Items Manager</h5>
        <button type="button" class="btn-close" onclick="$('.item-manager-model').modal('hide');"
          aria-label="Close"></button>
      </div>
      <div class="modal-body item-manager-model-body">
        ...
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="$('.item-manager-model').modal('hide');">Close</button>
        <button type="button" class="btn btn-primary" onclick="addSelectedItemsToMenu()">Add Selected items to
          menu</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade create-item-model" tabindex="2" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Create Item</h5>
        <button type="button" class="btn-close" onclick="$('.create-item-model').modal('hide');"
          aria-label="Close"></button>
      </div>
      <div class="modal-body create-item-model-body">
        Item Name: <input type="text" id="item-name" class="form-control" placeholder="Veg Biriyani" /><br>
        Item Price: <input type="number" id="item-price" class="form-control" value="10" /><br>
        Item Default Quantity: <input type="number" id="item-quantity" class="form-control" min="1" value="1" /><br>
        Item Type: <select id="item-type" class="form-control">
          <option value="0">Vegetarian</option>
          <option value="1">Non-Vegetarian</option>
        </select>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="$('.create-item-model').modal('hide');">Close</button>
        <button type="button" class="btn btn-primary" onclick="createItem()">Create item</button>
      </div>
    </div>
  </div>
</div>

<script>
  /***
   * TODO:
     - Delete Items (maybe not - bad idea)
     - Filter function??
   */
  document.title = "Menu Management";

  let menuList = [];

  // Default values
  let selectedDate = new Date(); // Today's date
  const today = new Date();
  document.getElementById('date-picker').value = today.toISOString().substr(0, 10); // set the default date of date picker to today
  let breakfastMenu, lunchMenu;
  let selectedMenuType = "Breakfast";

  // -- Menu Management Methods --
  const displayMenu = async () => {
    try { 
      const res = await CMS_API.MENU.getMenuListByDate(selectedDate.toISOString().slice(0, 10));
      if (res.status == 400) throw "No Menu List for the day";
      menuList = await res.json(); 
    }
    catch (e) { menuList = []; }

    breakfastMenu = menuList.filter(menu => {
      const menuDate = new Date(menu.date);
      console.log(menuDate)
      return menuDate.getDate() === selectedDate.getDate() &&
        menuDate.getMonth() === selectedDate.getMonth() &&
        menuDate.getFullYear() === selectedDate.getFullYear() &&
        menu.menuType == "Breakfast";
    })[0] || null;
    lunchMenu = menuList.filter(menu => {
      const menuDate = new Date(menu.date);
      return menuDate.getDate() === selectedDate.getDate() &&
        menuDate.getMonth() === selectedDate.getMonth() &&
        menuDate.getFullYear() === selectedDate.getFullYear() &&
        menu.menuType == "Lunch";
    })[0] || null;
    const selectedMenu = selectedMenuType === "Breakfast" ? breakfastMenu : lunchMenu;

    const menuListElem = document.getElementById('menu-list');
    menuListElem.innerHTML = '';
    if (selectedMenu) {
      selectedMenu.items.forEach(item => {
        const itemElem = document.createElement('div');
        itemElem.classList.add('list');
        itemElem.classList.add('px-4');
        itemElem.classList.add('justify-content-between');
        itemElem.innerHTML = `
          <div style="width:200px">
            <p>${item.name}</p>
          </div>
          <div>
            Recomended Quantity:<br>
            ${item.quantity}
          </div>
          <div>
            Price:<br>
            ${item.price}
          </div>
          <div>
            <a href="#" onclick="deleteItemFromMenu(${item.id});">Delete</a>
          </div>
        `;
        menuListElem.append(itemElem);
      });
      const addItemElement = document.createElement("div");
      addItemElement.innerHTML = `<div class="list justify-content-center clickable-list" onclick="showItemManager();">
    			<div>+ Add Item to Menu</div>
    	    </div>
			`;
      menuListElem.append(addItemElement);
    } else {
      menuListElem.innerHTML = `
      <div class="d-flex justify-content-center">
        No ${selectedMenuType} menu exists for this day.&nbsp;&nbsp;<a href="#" onclick="createNewMenu();" class="text-center" style="display: contents;">Create New Menu</a>?
      </div>`;
    }
  };

  createNewMenu = async () => {
    const response = await CMS_API.MENU.addMenu(selectedDate.toISOString().slice(0, 10), selectedMenuType);
    if(response.status != 200) {
      const responseJSON = await response.json();
      showToast(`Failed to create new menu. Error: ${responseJSON.message}`, 5000, 'danger');
    }
    else {
      displayMenu();
    }
  }

  // Event Handlers
  displayMenu();

  document.getElementById('date-picker').addEventListener('change', (e) => {
    selectedDate = new Date(e.target.value);
    document.getElementById('breakfastTab').click();  // This will automatically call displayMenu
    // displayMenu();
  });

  document.getElementById('breakfastTab').addEventListener('click', (e) => {
    selectedMenuType = 'Breakfast';
    document.getElementById('breakfastTab').classList.add('active');
    document.getElementById('lunchTab').classList.remove('active');
    displayMenu();
  });

  document.getElementById('lunchTab').addEventListener('click', (e) => {
    selectedMenuType = 'Lunch';
    document.getElementById('lunchTab').classList.add('active');
    document.getElementById('breakfastTab').classList.remove('active');
    displayMenu();
  });

  // -- Item Manager Model Methods -- 
  const showItemManager = async () => {
    $('.item-manager-model').modal('show');
    // Load items from server
    const itemManagerBodyElem = document.querySelector('.item-manager-model-body');
    itemManagerBodyElem.innerHTML = '';
    const response = await CMS_API.ITEM.getAllItems();
    const responseJSON = await response.json();
    if(responseJSON.status && responseJSON.status != 200) {
      showToast(`Failed to show items. Error: ${responseJSON.message}`, 5000, 'danger');
      return;
    }
    const items = responseJSON;

    // Display the items list
    items.forEach(item => {
      const itemElem = document.createElement('div');
      itemElem.classList.add('list');
      itemElem.classList.add('px-4');
      itemElem.classList.add('justify-content-between');
      itemElem.innerHTML = `
          <div>
            <input type="checkbox" id="item-${item.id}" name="item-selected" value="${item.id}">
          </div>
          <div style="width:200px">
            <p>${item.name}</p>
          </div>
          <div>
            Recomended Quantity:<br>
            ${item.quantity}
          </div>
          <div>
            Price:<br>
            ${item.price}
          </div>
        `;
      itemManagerBodyElem.append(itemElem);
    });
    const createItemElement = document.createElement('div');
    createItemElement.innerHTML = `<div class="list justify-content-center clickable-list" onclick="showCreateItemModal();">
        <div>+ Create new Item</div>
    </div>
	`;
    itemManagerBodyElem.append(createItemElement);

    // Disable the items already in the selected menu
    const selectedMenu = selectedMenuType === "Breakfast" ? breakfastMenu : lunchMenu;
    if (selectedMenu) {
      selectedMenu.items.forEach(item => {
        const itemElem = document.getElementById(`item-${item.id}`);
        itemElem.disabled = true;
      });
    }
  }
  const addSelectedItemsToMenu = async () => {
    const selectedItems = document.querySelectorAll('input[name="item-selected"]:checked');
    const selectedItemsIds = [];
    selectedItems.forEach(item => {
      selectedItemsIds.push(item.value);
    });
    if (selectedItemsIds.length == 0) return;

    const selectedMenu = selectedMenuType === "Breakfast" ? breakfastMenu : lunchMenu;
    const response = await CMS_API.MENU.addItemListToMenu(selectedMenu.id, ...selectedItemsIds);
    if(response.status == 200) {
      $('.item-manager-model').modal('hide');
      displayMenu();
    }
    else {
      const responseJSON = await response.json();
      showToast(`Error adding items to menu. Error: ${responseJSON.message}`, 5000, 'danger');
    }
  }

  const deleteItemFromMenu = async (itemId) => {
    const selectedMenu = selectedMenuType === "Breakfast" ? breakfastMenu : lunchMenu;
    const response = await CMS_API.MENU.removeItemFromMenu(selectedMenu.id, itemId);
    if(response.status == 200) {
      displayMenu();
    }
    else {
      const responseJSON = await response.json();
      showToast(`Error deleting item from menu. Error: ${responseJSON.message}`, 5000, 'danger');
    }
  }

  // -- Create Item Model Methods --
  const showCreateItemModal = () => {
    $('.create-item-model').modal('show');
  }

  const createItem = async () => {
    const itemName = document.getElementById('item-name').value;
    const itemQuantity = document.getElementById('item-quantity').value;
    const itemPrice = document.getElementById('item-price').value;
    const itemType = document.getElementById('item-type').value;
    const response = await CMS_API.ITEM.addItem({
        name: itemName,
        quantity: itemQuantity,
        price: itemPrice,
        type: itemType
      });
    if(response.status == 200) {
      $('.create-item-model').modal('hide');
      showItemManager();
    }
    else {
      const responseJSON = await response.json();
      showToast(`Failed to create new item. Error: ${responseJSON.message}`, 5000, 'danger');
    }
  }

  // -- Util Functions --
  const showToast = async (msg, timeout, toastType = 'primary') => {
        const toast = document.createElement('div'); 
        toast.classList.add('toast', 'position-fixed', 'bottom-0', 'end-0', 'm-3', `bg-${toastType}`, `text-white`);
        toast.classList.add('toast', 'fade', 'position-fixed', 'bottom-0', 'end-0', 'm-3');
        toast.setAttribute('style', 'z-index: 1061;');
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        toast.innerHTML = `
        <div class="toast-body d-flex">
            <div>${msg}</div>
            <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close"></button>

        </div>
        `;
        document.body.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast, { autohide: true, delay: timeout });
        bsToast.show();
    }
</script>


<style>
  .list {
    display: flex;
    flex-wrap: wrap;
    align-content: space-between;
    background-color: #83afd3;
    padding: 2px;
    margin-top: 10px;
    border-radius: 30px;
    align-items: center;
  }

  .clickable-list:hover {
    background-color: #759DBD;
    cursor: pointer;
  }

  .clickable-list {
    font-weight: bold;
  }

  .item {
    flex: 2;
    margin-left: 30px;
    align-items: center;
    align-self: center;
    font-size: 18px;
    margin-top: 10px;

  }

  .quantity {
    flex: 1;
    align-self: center;
  }

  .price {
    flex: 1;
    align-self: center;
  }


  .total {
    flex: 1;
    align-self: center;
  }
</style>